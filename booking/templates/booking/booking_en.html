{% extends 'booking/base.html' %}

{% block title %}Studio Booking - Danov Music Studio{% endblock %}

{% block extra_css %}
<style>
/* Disable browser autocomplete for phone field */
#id_phone {
	-webkit-autofill: none !important;
	-webkit-text-fill-color: inherit !important;
	background-color: transparent !important;
}

#id_phone::-webkit-outer-spin-button,
#id_phone::-webkit-inner-spin-button {
	-webkit-appearance: none;
	margin: 0;
}

/* Disable browser suggestions */
#id_phone:-webkit-autofill,
#id_phone:-webkit-autofill:hover,
#id_phone:-webkit-autofill:focus,
#id_phone:-webkit-autofill:active {
	-webkit-box-shadow: 0 0 0 30px white inset !important;
	-webkit-text-fill-color: inherit !important;
	transition: background-color 5000s ease-in-out 0s;
}
</style>
{% endblock %}

{% block content %}
<!-- Booking Section -->
<section class="hero" style="min-height: 45vh;">
	<!-- Background Video -->
	<div class="hero-video-background">
		{% load static %}
		<video autoplay muted loop playsinline preload="none">
			<source src="{% static 'videos/gg3.mp4' %}" type="video/mp4">
			Your browser does not support the video tag.
		</video>
		<div class="video-overlay"></div>
	</div>
	
	<div class="container">
		<div class="row align-items-center">
			<div class="col-lg-8 hero-content">
				<h1 class="display-4 fw-bold mb-4">
					Book Studio Time
				</h1>
				<p class="lead">
					Book your recording session in our Berlin studio
				</p>
			</div>
		</div>
	</div>
</section>

<!-- Booking Form Section -->
<section class="section" style="padding-bottom: 8rem !important;">
	<style>
		@media screen and (max-width: 768px) {
			section.section:last-of-type {
				padding-bottom: 8rem !important;
			}
		}
		@media screen and (max-width: 480px) {
			section.section:last-of-type {
				padding-bottom: 10rem !important;
			}
		}
	</style>
	<div class="container">
		<div class="row">
			<div class="col-lg-8 mx-auto">
				<!-- Selected Service Info -->
				{% if selected_service_info %}
				<div class="card mb-4">
					<div class="card-body">
						<div class="row align-items-center">
							<div class="col-md-8">
								<h4 class="card-title">{{ selected_service_info.name }}</h4>
								<p class="card-text">{{ selected_service_info.description }}</p>
								<div class="service-price">{{ selected_service_info.price }}</div>
							</div>
							<div class="col-md-4 text-end">
								<a href="{% url 'booking:services' %}" class="btn btn-outline-light">
									<i class="fas fa-arrow-left me-2"></i>Change Service
								</a>
							</div>
						</div>
					</div>
				</div>
				{% endif %}
				
				<!-- Available Times -->
				{% if available_dates %}
				<div class="card mb-4">
					<div class="card-body">
						<h5 class="card-title"><i class="fas fa-calendar-check me-2"></i>Available Times</h5>
						<p class="card-text">Select your preferred date and time:</p>
						
						<div class="row">
							{% for date_info in available_dates %}
							<div class="col-md-6 mb-3">
								<div class="card booking-date-card">
									<div class="card-body">
										<h6 class="card-title">{{ date_info.date|date:"l, F j" }}</h6>
										<div class="d-flex flex-wrap gap-2">
											{% for time_slot in date_info.times %}
											{% if time_slot.status == 'available' %}
											<button class="btn btn-outline-primary btn-sm time-slot" 
													data-date="{{ date_info.date|date:'Y-m-d' }}" 
													data-time="{{ time_slot.time }}"
													title="Available">
												{{ time_slot.time }}
											</button>
											{% else %}
											<button class="btn btn-outline-primary btn-sm time-slot-{{ time_slot.status }}" 
													disabled
													title="{{ time_slot.reason }}">
												{{ time_slot.time }}
											</button>
											{% endif %}
											{% endfor %}
										</div>
									</div>
								</div>
							</div>
							{% endfor %}
						</div>
					</div>
				</div>
				{% endif %}
				
				
				<!-- Booking Form -->
				<div class="booking-form">
					<h3><i class="fas fa-calendar-plus me-2"></i>Booking Form</h3>
					
					<form id="bookingForm" method="post">
						{% csrf_token %}
						
						<div id="alertContainer"></div>
						
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="{{ form.name.id_for_label }}" class="form-label">
									<i class="fas fa-user me-2"></i>Your Name *
								</label>
								{{ form.name }}
								{% if form.name.errors %}
									<div class="text-danger small">{{ form.name.errors.0 }}</div>
								{% endif %}
							</div>
							
							<div class="col-md-6 mb-3">
								<label for="{{ form.email.id_for_label }}" class="form-label">
									<i class="fas fa-envelope me-2"></i>Email *
								</label>
								{{ form.email }}
								{% if form.email.errors %}
									<div class="text-danger small">{{ form.email.errors.0 }}</div>
								{% endif %}
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="{{ form.phone.id_for_label }}" class="form-label">
									<i class="fas fa-phone me-2"></i>Phone *
								</label>
								{{ form.phone }}
								{% if form.phone.errors %}
									<div class="text-danger small">{{ form.phone.errors.0 }}</div>
								{% endif %}
							</div>
							
							<div class="col-md-6 mb-3">
								<label for="{{ form.service.id_for_label }}" class="form-label">
									<i class="fas fa-cogs me-2"></i>Service *
								</label>
								{{ form.service }}
								{% if form.service.errors %}
									<div class="text-danger small">{{ form.service.errors.0 }}</div>
								{% endif %}
								{% if selected_service %}
								<div class="text-success small mt-1">
									<i class="fas fa-check-circle me-1"></i>Service pre-selected: {{ selected_service|title }}
								</div>
								{% endif %}
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="{{ form.date.id_for_label }}" class="form-label">
									<i class="fas fa-calendar me-2"></i>Date *
								</label>
								{{ form.date }}
								{% if form.date.errors %}
									<div class="text-danger small">{{ form.date.errors.0 }}</div>
								{% endif %}
							</div>
							
							<div class="col-md-6 mb-3">
								<label for="{{ form.time.id_for_label }}" class="form-label">
									<i class="fas fa-clock me-2"></i>Time *
								</label>
								{{ form.time }}
								{% if form.time.errors %}
									<div class="text-danger small">{{ form.time.errors.0 }}</div>
								{% endif %}
							</div>
						</div>
						
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="{{ form.duration.id_for_label }}" class="form-label">
									<i class="fas fa-hourglass-half me-2"></i>Duration *
								</label>
								{{ form.duration }}
								{% if form.duration.errors %}
									<div class="text-danger small">{{ form.duration.errors.0 }}</div>
								{% endif %}
							</div>
						</div>
						
						<div class="mb-3">
							<label for="{{ form.message.id_for_label }}" class="form-label">
								<i class="fas fa-comment me-2"></i>Additional Information
							</label>
							{{ form.message }}
							{% if form.message.errors %}
								<div class="text-danger small">{{ form.message.errors.0 }}</div>
							{% endif %}
						</div>
						
                        {% if captcha_enabled %}
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-shield-alt me-2"></i>Security Check *
                            </label>
                            {{ form.captcha }}
                            {% if form.captcha.errors %}
                                <div class="text-danger small">{{ form.captcha.errors.0 }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
						
						<div class="loading" id="loading">
							<div class="spinner"></div>
							<p>Sending booking request...</p>
						</div>
						
						<div class="text-center">
							<button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
								<i class="fas fa-paper-plane me-2"></i>Send Booking Request
							</button>
						</div>
					</form>
				</div>
				
				<!-- Booking Info -->
				<div class="row mt-5 mb-5 booking-info-cards" style="margin-bottom: 4rem !important;">
					<style>
						@media screen and (max-width: 768px) {
							.booking-info-cards {
								margin-bottom: 6rem !important;
							}
							.row.booking-info-cards {
								margin-bottom: 6rem !important;
							}
						}
						@media screen and (max-width: 480px) {
							.booking-info-cards {
								margin-bottom: 8rem !important;
							}
							.row.booking-info-cards {
								margin-bottom: 8rem !important;
							}
						}
					</style>
					<div class="col-md-4">
						<div class="card text-center h-100">
							<div class="card-body">
								<div class="service-icon">
									<i class="fas fa-clock"></i>
								</div>
								<h5 class="card-title">Opening Hours</h5>
								<p class="card-text">Mon-Fri: 9:00-21:30<br>Sat: Closed<br>Sun: Closed</p>
							</div>
						</div>
					</div>
					
					<div class="col-md-4">
						<div class="card text-center h-100">
							<div class="card-body">
								<div class="service-icon">
									<i class="fas fa-phone"></i>
								</div>
								<h5 class="card-title">Contact Us</h5>
								<p class="card-text">+49 175 413 75 18</p>
							</div>
						</div>
					</div>
					
					<div class="col-md-4">
						<div class="card text-center h-100">
							<div class="card-body">
								<div class="service-icon">
									<i class="fas fa-map-marker-alt"></i>
								</div>
								<h5 class="card-title">Studio Location</h5>
								<p class="card-text">Berlin, Germany</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>


{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
	// Phone field setup - prevent autofill
	const phoneField = document.getElementById('id_phone');
	if (phoneField) {
		// Ensure autocomplete is off
		phoneField.setAttribute('autocomplete', 'off');
		phoneField.setAttribute('data-lpignore', 'true');
	}
	
	// Auto-focus on service field if pre-selected
	const serviceSelect = document.getElementById('id_service');
	
	// Check if service is pre-selected from URL parameter
	const urlParams = new URLSearchParams(window.location.search);
	const selectedService = urlParams.get('service');
	
	if (selectedService && serviceSelect) {
		// Save selected service to localStorage
		localStorage.setItem('selectedService', selectedService);
		
		// Find and select the option with the matching value
		for (let option of serviceSelect.options) {
			if (option.value === selectedService) {
				option.selected = true;
				break;
			}
		}
		
		// Add visual highlight to the service field
		serviceSelect.style.borderColor = '#28a745';
		serviceSelect.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
		
		// Scroll to service field
		serviceSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
		
		console.log('Service pre-selected:', selectedService);
	} else if (serviceSelect) {
		// Check if we have a saved service in localStorage
		const savedService = localStorage.getItem('selectedService');
		if (savedService) {
			// Find and select the option with the matching value
			for (let option of serviceSelect.options) {
				if (option.value === savedService) {
					option.selected = true;
					break;
				}
			}
			
			// Add visual highlight to the service field
			serviceSelect.style.borderColor = '#28a745';
			serviceSelect.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
			serviceSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
			
			console.log('Service restored from localStorage:', savedService);
		} else if (serviceSelect.value && serviceSelect.value !== '') {
			// Fallback: if form already has a value
			serviceSelect.style.borderColor = '#28a745';
			serviceSelect.style.boxShadow = '0 0 0 0.2rem rgba(40, 167, 69, 0.25)';
			serviceSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
		}
	}
	
	// Handle time slot selection
	const timeSlots = document.querySelectorAll('.time-slot');
	const dateInput = document.getElementById('id_date');
	const timeInput = document.getElementById('id_time');
	
	timeSlots.forEach(slot => {
		slot.addEventListener('click', function() {
			// Remove active class from all slots
			timeSlots.forEach(s => s.classList.remove('btn-primary'));
			timeSlots.forEach(s => s.classList.add('btn-outline-primary'));
			
			// Add active class to clicked slot
			this.classList.remove('btn-outline-primary');
			this.classList.add('btn-primary');
			
			// Set form values
			dateInput.value = this.dataset.date;
			timeInput.value = this.dataset.time;
		});
	});
	
	// Handle form submission
	const form = document.getElementById('bookingForm');
	const submitBtn = document.getElementById('submitBtn');
	const loading = document.getElementById('loading');
	const alertContainer = document.getElementById('alertContainer');
	
	let isSubmitting = false;
	
	form.addEventListener('submit', function(e) {
		e.preventDefault();
		
		// Prevent multiple submissions
		if (isSubmitting) {
			return false;
		}
		
		isSubmitting = true;
		
		// Show loading
		submitBtn.style.display = 'none';
		loading.style.display = 'block';
		
		// Submit form via AJAX
		console.log('Submitting form...'); // Debug log
		fetch('', {
			method: 'POST',
			body: new FormData(form),
			headers: {
				'X-Requested-With': 'XMLHttpRequest',
			}
		})
		.then(response => {
			console.log('Response status:', response.status); // Debug log
			return response.json();
		})
		.then(data => {
			console.log('Response data:', data); // Debug log
			if (data.success) {
				alertContainer.innerHTML = `
					<div class="alert alert-success">
						${data.message}
					</div>
				`;
				form.reset();
				// Clear saved service from localStorage after successful submission
				localStorage.removeItem('selectedService');
			} else {
				alertContainer.innerHTML = `
					<div class="alert alert-danger">
						${data.message}
					</div>
				`;
			}
		})
		.catch(error => {
			console.error('Fetch error:', error); // Debug log
			alertContainer.innerHTML = `
				<div class="alert alert-danger">
					Error sending booking request. Please try again.
				</div>
			`;
		})
		.finally(() => {
			// Hide loading
			submitBtn.style.display = 'block';
			loading.style.display = 'none';
			isSubmitting = false;
		});
	});
});
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {"@type": "Question","name": "How do I book a session?","acceptedAnswer": {"@type": "Answer","text": "Choose date, time and duration in the booking form and submit your request."}},
    {"@type": "Question","name": "Can I cancel or reschedule?","acceptedAnswer": {"@type": "Answer","text": "Yes. Contact us in advance to cancel or reschedule your session."}},
    {"@type": "Question","name": "What payment methods do you accept?","acceptedAnswer": {"@type": "Answer","text": "We accept standard cashless payments and provide invoices upon request."}}
  ]
}
</script>
{% endblock %}
